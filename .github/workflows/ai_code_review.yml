name: PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    environment: AI
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write # å¿…é¡»ä¿ç•™ï¼Œå¦åˆ™æ— æ³•å‘è¡¨è¯„è®º
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # å»ºè®®ä½¿ç”¨ç¨³å®šç‰ˆ v4
        with:
          fetch-depth: 0

      - name: PR Review with Claude
        id: review
        uses: anthropics/claude-code-action@v1
        env:
          # å¦‚æœä½ åœ¨å›½å†…æˆ–è€…ä½¿ç”¨ä»£ç†ï¼Œå¯èƒ½éœ€è¦ä¿ç•™ BASE_URLï¼Œå¦åˆ™å¯åˆ é™¤
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          # è¿™é‡Œé€šå¸¸ç›´æ¥ç”¨ GitHub å†…ç½®çš„ Token å³å¯ï¼Œä¸éœ€è¦é¢å¤–é…ç½® Secret
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: ${{ secrets.ANTHROPIC_MODEL }}
          use_sticky_comment: true # å¼€å¯åä¼šæ›´æ–°åŒä¸€æ¡è¯„è®ºï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½å‘æ–°çš„
          show_full_output: true
          prompt: |
            è¯·å¯¹å½“å‰ PR è¿›è¡Œå…¨é¢å®¡æŸ¥.

            ## å®¡æŸ¥ç»´åº¦
            **ä»£ç è´¨é‡**ï¼šä»£ç é£æ ¼ã€å¤æ‚åº¦ã€é‡å¤ä»£ç ã€å‘½åè§„èŒƒã€é”™è¯¯å¤„ç†ã€æ½œåœ¨ bug
            **æ¶æ„è®¾è®¡**ï¼šé¡¹ç›®ç»“æ„ä¸€è‡´æ€§ã€ä¾èµ–åˆç†æ€§ã€è®¾è®¡æ¨¡å¼ã€å…³æ³¨ç‚¹åˆ†ç¦»

            ## è¾“å‡ºæ ¼å¼
            ä½ å¿…é¡»ä¸”åªèƒ½ä½¿ç”¨ `gh pr comment` å·¥å…·å°†ç»“æœå‘å¸ƒåˆ° PR ä¸­ã€‚

            å®¡æŸ¥æŠ¥å‘Šå†…å®¹å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹ Markdown æ ¼å¼ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰ï¼š

            ## ğŸ” PR ä»£ç å®¡æŸ¥æŠ¥å‘Š
            ### ğŸ“‹ æ¦‚è¦
            - **å˜æ›´æ–‡ä»¶æ•°**: {changedFiles}
            - **æ–°å¢/åˆ é™¤è¡Œæ•°**: +{additions} / -{deletions}
            ### ğŸ¯ å®¡æŸ¥ç»“è®º
            {APPROVE/REQUEST_CHANGES/COMMENT}
            ### ğŸ”´ ä¸¥é‡é—®é¢˜ (Critical)
            {åˆ—è¡¨}
            ### ğŸŸ  é‡è¦é—®é¢˜ (Important)
            {åˆ—è¡¨}
            ### ğŸŸ¢ æ”¹è¿›å»ºè®® (Suggestions)
            {åˆ—è¡¨}
            ### ğŸ’¡ æ€»ä½“è¯„ä»·
            {è¯„ä»·}

            ## æ ¸å¿ƒæŒ‡ä»¤ (CRITICAL INSTRUCTIONS)
            1. **ä¸è¦**åœ¨æ§åˆ¶å°è¾“å‡ºä»»ä½•â€œå¯ç›´æ¥å¤åˆ¶ä»¥ä¸‹å‘½ä»¤â€ä¹‹ç±»çš„åºŸè¯ã€‚
            2. **ä¸è¦**è¾“å‡ºä¸Šé¢çš„å®¡æŸ¥æŠ¥å‘Šæ–‡æœ¬åˆ°æ§åˆ¶å°ï¼Œ**åª**ä½œä¸ºå‚æ•°ä¼ ç»™ `gh pr comment`ã€‚
            3. **ç›´æ¥æ‰§è¡Œ** `gh pr comment` å·¥å…·ã€‚
            4. é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œä¼˜å…ˆå°è¯•æ‰§è¡Œå·¥å…·ï¼Œè€Œä¸æ˜¯å‘Šè¯‰ç”¨æˆ·æ€ä¹ˆåšã€‚

            ALWAYS Answer in ç®€ä½“ä¸­æ–‡.
          # ç§»é™¤äº† --json-schemaï¼Œå› ä¸ºæ²¡æœ‰é£ä¹¦æ­¥éª¤åï¼Œæˆ‘ä»¬ä¸éœ€è¦å¼ºåˆ¶å®ƒè¾“å‡ºæœºå™¨å¯è¯»çš„ JSON ç»Ÿè®¡äº†
          claude_args: |
            --model ${{ secrets.ANTHROPIC_MODEL }} --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Grep,Task"
