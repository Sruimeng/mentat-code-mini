name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write # å…è®¸åˆ›å»º Release

jobs:
  # ä»»åŠ¡ 1: ç¼–è¯‘ä¸‰ä¸ªå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: mentat-linux-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            name: mentat-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            name: mentat-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: mentat-win-x64.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build Binary
        run: cargo build --release --target ${{ matrix.target }}

      # ğŸ‘‡ æ­¥éª¤ A: é‡å‘½åå¹¶å‡†å¤‡æ–‡ä»¶
      - name: Prepare Binary
        shell: bash
        run: |
          # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»æ˜¯ä½  Cargo.toml [[bin]] é‡Œå†™çš„åå­—
          # æ ¹æ®ä¹‹å‰çš„æ²Ÿé€šï¼Œä½ çš„ bin åå­—æ˜¯ "mentat-cli-mini"
          SRC_NAME="mentat-cli-mini"
          
          # Windows ä¸‹æºæ–‡ä»¶æœ‰ .exe åç¼€
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            cp target/${{ matrix.target }}/release/${SRC_NAME}.exe ${{ matrix.name }}
          else
            cp target/${{ matrix.target }}/release/${SRC_NAME} ${{ matrix.name }}
          fi

      # ğŸ‘‡ æ­¥éª¤ B: ä¸Šä¼ åˆ° GitHub Release (å¯é€‰ï¼Œæ–¹ä¾¿ç”¨æˆ·æ‰‹åŠ¨ä¸‹è½½)
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ‘‡ æ­¥éª¤ C: ä¸Šä¼ ä¸º Artifact (å…³é”®ï¼ä¼ ç»™ NPM ä»»åŠ¡ç”¨)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.name }} # ç»™ä¸´æ—¶æ–‡ä»¶èµ·ä¸ªå
          path: ${{ matrix.name }}
          retention-days: 1

  # ä»»åŠ¡ 2: æ‰“åŒ…å¹¶å‘å¸ƒåˆ° NPM
  publish-to-npm:
    name: Publish to NPM
    needs: build # å¿…é¡»ç­‰ä¸Šé¢ build ä»»åŠ¡å…¨éƒ¨å®Œæˆ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # ğŸ‘‡ æ­¥éª¤ D: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts # ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•

      # ğŸ‘‡ æ­¥éª¤ E: æŠŠæ–‡ä»¶æ¬è¿åˆ° npm-package/bin/ ç›®å½•
      - name: Organize Binaries
        run: |
          mkdir -p npm-package/bin
          
          echo "Moving binaries to npm-package/bin/..."
          
          # ä» artifacts ä¸´æ—¶ç›®å½•æŠŠæ–‡ä»¶ç§»åŠ¨å‡ºæ¥
          # è·¯å¾„ç»“æ„é€šå¸¸æ˜¯: artifacts/binary-åå­—/åå­—
          mv artifacts/binary-mentat-linux-x64/* npm-package/bin/
          mv artifacts/binary-mentat-macos-x64/* npm-package/bin/
          mv artifacts/binary-mentat-macos-arm64/* npm-package/bin/
          mv artifacts/binary-mentat-win-x64.exe/* npm-package/bin/
          
          # ç»™ Linux/Mac äºŒè¿›åˆ¶æ–‡ä»¶èµ‹äºˆæ‰§è¡Œæƒé™ (éå¸¸é‡è¦ï¼)
          chmod +x npm-package/bin/*
          
          # åˆ—å‡ºæ–‡ä»¶ç¡®è®¤ä¸€ä¸‹
          ls -R npm-package/bin/

      # ğŸ‘‡ æ­¥éª¤ F: å‘å¸ƒåˆ° NPM
      - name: Publish to NPM
        run: |
          cd npm-package
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}